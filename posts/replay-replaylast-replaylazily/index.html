<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Davel"><title>replay, replayLast 和 replayLazily 的区别 ｜ 一言半辞</title><meta name=description content=" 翻译自 Patrick Bacon的Comparing replay, replayLast, and replayLazily
 一位同事最近问我关于 ReactiveCocoa 中replay,replayLast和replayLazily的区别，才发现我只是对它们有一个模糊的理解，并不能把它们的区别解释的很清楚，所以我认为我应该深入了解一下。
你会发现，如果对RACReplaySubject和RACMulticastConnection没有一个很好的理解的话，只看头文件中的注释还是很难看懂，所以我试图在不涉及的底层概念的情况下解释一下这几个replay方法。
"><meta name=keywords content="Hugo,theme,zozo"><link rel="shortcut icon" href=http://localhost:1313/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/highlight.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=http://localhost:1313/><span>一言半辞</span></a></h1></div><div class=description><p class=sub_title></p><div class=my_socials><a href=http://localhost:1313/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/replay-replaylast-replaylazily/>replay, replayLast 和 replayLazily 的区别</a></h2><span class=date>2016.07.03</span></div><div class="post_content markdown"><blockquote><p><em>翻译自 <a href=https://spin.atomicobject.com/author/bacon/>Patrick Bacon</a>的<a href=https://spin.atomicobject.com/2014/06/29/replay-replaylast-replaylazily/>Comparing replay, replayLast, and replayLazily</a></em></p></blockquote><p>一位同事最近问我关于 ReactiveCocoa 中<code>replay</code>,<code>replayLast</code>和<code>replayLazily</code>的区别，才发现我只是对它们有一个模糊的理解，并不能把它们的区别解释的很清楚，所以我认为我应该深入了解一下。</p><p>你会发现，如果对<code>RACReplaySubject</code>和<code>RACMulticastConnection</code>没有一个很好的理解的话，只看头文件中的注释还是很难看懂，所以我试图在不涉及的底层概念的情况下解释一下这几个replay方法。</p><h3 id=订阅一个信号>订阅一个信号</h3><p>对于一个“正常的”<code>RACSignal</code>，每个订阅都会使signal的<code>didSubscribe</code> block<a href=https://ooopscc.github.io/Compare-replay-replayLast-and-replayLazily/#fn:1>1</a>再执行一次，并且subscriber只会接收到在订阅**<em>之后</em>**发送的值。可能看个例子会更好理解一点。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=k>__block</span> <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=p>[</span><span class=n>RACSignal</span> <span class=nl>createSignal</span><span class=p>:</span><span class=o>^</span><span class=n>RACDisposable</span> <span class=o>*</span><span class=p>(</span><span class=kt>id</span>  <span class=n>subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Increment num to: %i&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=n>subscriber</span> <span class=nl>sendNext</span><span class=p>:</span><span class=l>@(</span><span class=n>num</span><span class=l>)</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>nil</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Start subscriptions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 1 (S1)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 2 (S2)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 3 (S3)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>输出为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Start subscriptions
</span></span><span class=line><span class=cl>Increment num to: 1
</span></span><span class=line><span class=cl>S1: 1
</span></span><span class=line><span class=cl>Increment num to: 2
</span></span><span class=line><span class=cl>S2: 2
</span></span><span class=line><span class=cl>Increment num to: 3
</span></span><span class=line><span class=cl>S3: 3
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-05.png><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-05.png alt></a>
正如你所见，每次订阅都导致<code>num</code>的值增加了。而且<code>num</code>的值是直到订阅发生了才开始计算的。这样，一个正常的RACSignal可以说是lazy的，因为只有有了subscriber它才会做事。</p><p>第二个例子将会展示每个subscriber只接收到 <strong>发送于订阅之后</strong> 的值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=n>RACSubject</span> <span class=o>*</span><span class=n>letters</span> <span class=o>=</span> <span class=p>[</span><span class=n>RACSubject</span> <span class=n>subject</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=n>letters</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;A&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;B&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;C&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;D&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>输出为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Subscribe S1
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send A
</span></span><span class=line><span class=cl>S1: A
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send B
</span></span><span class=line><span class=cl>S1: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S2
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send C
</span></span><span class=line><span class=cl>S1: C
</span></span><span class=line><span class=cl>S2: C
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send D
</span></span><span class=line><span class=cl>S1: D
</span></span><span class=line><span class=cl>S2: D
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-02.png><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-02.png alt></a></p><p>在大多数情况下，这正如预期。但也有一些情况，你不想订阅的代码（subscription code）被重复执行，比如一个订阅是做一个网络请求，当数据回来时有多个监听者需要使用进行更新操作；或者可能是你想得到此次订阅之前的发送过的值。这正是<code>-replay</code>，<code>-replayLast</code>和<code>-replayLazily</code>的使用场景。</p><h3 id=httpsooopsccgithubiocompare-replay-replaylast-and-replaylazily订阅一个-replay信号-订阅一个-replay信号订阅一个-replay信号><a href=https://ooopscc.github.io/Compare-replay-replayLast-and-replayLazily/#%E8%AE%A2%E9%98%85%E4%B8%80%E4%B8%AA-replay%E4%BF%A1%E5%8F%B7 title=订阅一个-replay信号></a>订阅一个<code>-replay</code>信号</h3><p><code>replay</code>便捷方法会返回一个新的signal，当订阅新的signal时，会直接把在源signal上所有发送的值都发送给subscriber，同时不会重新执行源signal的<code>didSubscribe</code> block。当然，这个subscriber也会收到所有将来的值，就像正常的signal一样。</p><p>第一个例子会展示在有新的订阅的时候不重新执行<code>didSubscribe</code> block：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=k>__block</span> <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RACSignal</span> <span class=nl>createSignal</span><span class=p>:</span><span class=o>^</span><span class=n>RACDisposable</span> <span class=o>*</span><span class=p>(</span><span class=kt>id</span>  <span class=n>subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Increment num to: %i&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=n>subscriber</span> <span class=nl>sendNext</span><span class=p>:</span><span class=l>@(</span><span class=n>num</span><span class=l>)</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>nil</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}]</span> <span class=n>replay</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Start subscriptions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 1 (S1)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 2 (S2)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 3 (S3)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>结果为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=n>Increment</span> <span class=n>num</span> <span class=nl>to</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Start</span> <span class=n>subscriptions</span>
</span></span><span class=line><span class=cl><span class=nl>S1</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nl>S2</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nl>S3</span><span class=p>:</span> <span class=mi>1</span>
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-06.png><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-06.png alt></a></p><p>这一次<code>num</code>的值在任何订阅产生之前就已经增加了。并且只增加了一次，即这个signal不管有多少subscriber，创建signal的<code>didSubscribe</code> block只会执行一次。</p><p>第二个例子展示新的subscriber会得到此订阅在这个signal上发送过的所有值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=n>RACSubject</span> <span class=o>*</span><span class=n>letters</span> <span class=o>=</span> <span class=p>[</span><span class=n>RACSubject</span> <span class=n>subject</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=p>[</span><span class=n>letters</span> <span class=n>replay</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;A&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;B&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;C&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;D&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>结果为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Subscribe S1
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send A
</span></span><span class=line><span class=cl>S1: A
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send B
</span></span><span class=line><span class=cl>S1: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S2
</span></span><span class=line><span class=cl>S2: A
</span></span><span class=line><span class=cl>S2: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send C
</span></span><span class=line><span class=cl>S1: C
</span></span><span class=line><span class=cl>S2: C
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send D
</span></span><span class=line><span class=cl>S1: D
</span></span><span class=line><span class=cl>S2: D
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S3
</span></span><span class=line><span class=cl>S3: A
</span></span><span class=line><span class=cl>S3: B
</span></span><span class=line><span class=cl>S3: C
</span></span><span class=line><span class=cl>S3: D
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-01.jpg><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-01.jpg alt></a></p><p>这里尽管S3是在所有值发送之后才订阅的，但它仍旧能获得之前的所有值。</p><h3 id=订阅一个-replaylast信号>订阅一个<code>-replayLast</code>信号</h3><p><code>-replayLast</code>便捷方法返回一个新的signal，当有subscirber订阅这个新signal的时候，它会直接把源signal最近的一个值发送给subscriber，而不需要重新执行signal的<code>didSubscribe</code> block。同正常的signal一样，这个subscriber会接收到在此之后的值。</p><p>第一个例子中，使用<code>-replayLast</code>和<code>-replay</code>没有任何区别，所以就不再列一遍了。</p><p>第二例子展示最新的值是如何提供给subscriber的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=n>RACSubject</span> <span class=o>*</span><span class=n>letters</span> <span class=o>=</span> <span class=p>[</span><span class=n>RACSubject</span> <span class=n>subject</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=p>[</span><span class=n>letters</span> <span class=n>replayLast</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;A&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;B&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;C&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;D&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>输出为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Subscribe S1
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send A
</span></span><span class=line><span class=cl>S1: A
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send B
</span></span><span class=line><span class=cl>S1: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S2
</span></span><span class=line><span class=cl>S2: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send C
</span></span><span class=line><span class=cl>S1: C
</span></span><span class=line><span class=cl>S2: C
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send D
</span></span><span class=line><span class=cl>S1: D
</span></span><span class=line><span class=cl>S2: D
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S3
</span></span><span class=line><span class=cl>S3: D
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-03.png><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-03.png alt></a></p><h3 id=订阅一个-replaylazily信号>订阅一个<code>-replayLazily</code>信号</h3><p><code>-replayLazily</code>便捷方法会返回一个新的signal，当被订阅时，会直接发送所有源signal上发送过的值，不重新执行源signal的<code>didSubscribe</code> block。<code>-replayLazily</code>和<code>-replay</code>的不同点在于前者直到有subscriber订阅了新的signal时，它才会去订阅源signal。正好是与<code>-repaly</code>和<code>-replayLast</code>相反的行为，它俩是一旦被调用会直接订阅源signal。</p><p>第一个例子会展示区别。注意“Increment num to: 1”在第一个订阅之后才出现。而<code>-repaly</code>和<code>-replayLazily</code>时订阅之前就已经出现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=k>__block</span> <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RACSignal</span> <span class=nl>createSignal</span><span class=p>:</span><span class=o>^</span><span class=n>RACDisposable</span> <span class=o>*</span><span class=p>(</span><span class=kt>id</span>  <span class=n>subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Increment num to: %i&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=n>subscriber</span> <span class=nl>sendNext</span><span class=p>:</span><span class=l>@(</span><span class=n>num</span><span class=l>)</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>nil</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}]</span> <span class=n>replayLazily</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Start subscriptions&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 1 (S1)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 2 (S2)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>// Subscriber 3 (S3)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>输出为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Start subscriptions
</span></span><span class=line><span class=cl>Increment num to: 1
</span></span><span class=line><span class=cl>S1: 1
</span></span><span class=line><span class=cl>S2: 1
</span></span><span class=line><span class=cl>S3: 1
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-07.png><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-07.png alt></a>
而第二个例子将展示所有发送过的值会发送给任何新的subscriber，就像<code>-replay</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objc data-lang=objc><span class=line><span class=cl><span class=n>RACSubject</span> <span class=o>*</span><span class=n>letters</span> <span class=o>=</span> <span class=p>[</span><span class=n>RACSubject</span> <span class=n>subject</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>RACSignal</span> <span class=o>*</span><span class=n>signal</span> <span class=o>=</span> <span class=p>[</span><span class=n>letters</span> <span class=n>replayLazily</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S1: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;A&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;B&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S2: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;C&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Send D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>letters</span> <span class=nl>sendNext</span><span class=p>:</span><span class=s>@&#34;D&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Subscribe S3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>signal</span> <span class=nl>subscribeNext</span><span class=p>:</span><span class=o>^</span><span class=p>(</span><span class=kt>id</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;S3: %@&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}];</span>
</span></span></code></pre></div><p>结果为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Subscribe S1
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send A
</span></span><span class=line><span class=cl>S1: A
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send B
</span></span><span class=line><span class=cl>S1: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S2
</span></span><span class=line><span class=cl>S2: A
</span></span><span class=line><span class=cl>S2: B
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send C
</span></span><span class=line><span class=cl>S1: C
</span></span><span class=line><span class=cl>S2: C
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Send D
</span></span><span class=line><span class=cl>S1: D
</span></span><span class=line><span class=cl>S2: D
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>Subscribe S3
</span></span><span class=line><span class=cl>S3: A
</span></span><span class=line><span class=cl>S3: B
</span></span><span class=line><span class=cl>S3: C
</span></span><span class=line><span class=cl>S3: D
</span></span></code></pre></div><p><a href=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-04.png><img src=https://spin.atomicobject.com/wp-content/uploads/Spin_MarbleChart-04.png alt></a></p><h3 id=总结>总结</h3><p>ReactiveCocoa提供了三个便捷方法可以使多个subscriber订阅同一个signal而不重新执行源signal的<code>didSubscribe</code> block，同时将全部或者最新的发送过的值给新的subscriber。<code>-replay</code>和<code>-replayLast</code>都会使信号变为热信号，会提供所有发送过的值（<code>-replay</code>）或者最新的发送过的值（<code>-replayLast</code>）给订阅者。而<code>-replayLazily</code>返回一个冷信号，会提供所有发送过的值给订阅者。</p><hr><ol><li>1.+ (RACSignal <em>)createSignal:(RACDisposable</em> ( ^ ) ( id subscriber ))didSubscribe <a href=https://ooopscc.github.io/Compare-replay-replayLast-and-replayLazily/#fnref:1>↩</a></li></ol></div><div class=post_footer></div></div><div class=doc_comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//davelliu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span></span></div></footer><script src=http://localhost:1313/js/jquery-3.5.1.min.js></script>
<link href=http://localhost:1313/css/fancybox.min.css rel=stylesheet><script src=http://localhost:1313/js/fancybox.min.js></script>
<script src=http://localhost:1313/js/zozo.js></script>
<script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style></body></html>